<script>
  $(document).ready( function() {
    // List of countries
    var countries = [
      { "name": "Afghanistan", "value": "afghanistan", "tokens": ["afghanistan"] },
      { "name": "Albania", "value": "albania", "tokens": ["albania"] },
      { "name": "Algeria", "value": "algeria", "tokens": ["algeria"] },
      { "name": "American Samoa", "value": "american samoa", "tokens": ["american samoa"] },
      { "name": "Andorra", "value": "andorra", "tokens": ["andorra"] },
      { "name": "Angola", "value": "angola", "tokens": ["angola"] },
      { "name": "Anguilla", "value": "anguilla", "tokens": ["anguilla"] },
      { "name": "Antigua and Barbuda", "value": "antigua and barbuda", "tokens": ["antigua and barbuda"] },
      { "name": "Argentina", "value": "argentina", "tokens": ['argentina', 'argentine nation', 'argentine confederation', 'united provinces of the rio de la plata'] },
      { "name": "Armenia", "value": "armenia", "tokens": ["armenia", "hayastan"] },
      { "name": "Aruba", "value": "aruba", "tokens": ["aruba"] },
      { "name": "Australia", "value": "australia", "tokens": ["commonwealth of australia"] },
      { "name": "Austria", "value": "austria", "tokens": ["austria"] },
      { "name": "Azerbaijan", "value": "azerbaijan", "tokens": ["azerbaijan"] },
      { "name": "Bahamas", "value": "bahamas", "tokens": ["bahamas"] },
      { "name": "Bahrain", "value": "bahrain", "tokens": ["bahrain"] },
      { "name": "Bangladesh", "value": "bangladesh", "tokens": ["bangladesh", "bengal"] },
      { "name": "Barbados", "value": "barbados", "tokens": ["barbados"] },
      { "name": "Belarus", "value": "belarus", "tokens": ["belarus", "byelorussia"] },
      { "name": "Belgium", "value": "belgium", "tokens": ["belgium"] },
      { "name": "Belize", "value": "belize", "tokens": ["belize", "british honduras"] },
      { "name": "Benin", "value": "benin", "tokens": ["benin", "dahomey"] },
      { "name": "Bermuda", "value": "bermuda", "tokens": ["bermuda"] },
      { "name": "Bhutan", "value": "bhutan", "tokens": ["bhutan"] },
      { "name": "Bolivia", "value": "bolivia", "tokens": ["bolivia"] },
      { "name": "Bonaire / St Eustatius / Saba", "value": "bonaire/st eustatius/saba", "tokens": ["bonaire/st eustatius/saba"] },
      { "name": "Bosnia and Herzegovina", "value": "bosnia and herzegovina", "tokens": ["bosnia and herzegovina"] },
      { "name": "Botswana", "value": "botswana", "tokens": ["botswana", "bechuanaland"] },
      { "name": "Brazil", "value": "brazil", "tokens": ["brazil", "brasil"] },
      { "name": "British indian ocean territory", "value": "british indian ocean territory", "tokens": ["british indian ocean territory"] },
      { "name": "British virgin islands", "value": "british virgin islands", "tokens": ["british virgin islands"] },
      { "name": "Brunei", "value": "brunei", "tokens": ["brunei"] },
      { "name": "Bulgaria", "value": "bulgaria", "tokens": ["bulgaria"] },
      { "name": "Burkina", "value": "burkina faso", "tokens": ["burkina faso, upper volta"] },
      { "name": "Burma", "value": "burma", "tokens": ["burma"] },
      { "name": "Burundi", "value": "burundi", "tokens": ["burundi"] },
      { "name": "Cambodia", "value": "cambodia", "tokens": ["cambodia", "khmer republic", "democratic kampuchea"] },
      { "name": "Cameroon", "value": "cameroon", "tokens": ["cameroon"] },
      { "name": "Canada", "value": "canada", "tokens": ["canada"] },
      { "name": "Cape verde", "value": "cape verde", "tokens": ["cape verde"] },
      { "name": "Cayman islands", "value": "cayman islands", "tokens": ["cayman islands"] },
      { "name": "Central African Republic", "value": "central african republic", "tokens": ["central african republic"] },
      { "name": "Chad", "value": "chad", "tokens": ["chad"] },
      { "name": "Chile", "value": "chile", "tokens": ["chile"] },
      { "name": "China", "value": "china", "tokens": ["china"] },
      { "name": "Colombia", "value": "colombia", "tokens": ["colombia"] },
      { "name": "Comoros", "value": "comoros", "tokens": ["comoros"] },
      { "name": "Congo", "value": "congo", "tokens": ["congo"] },
      { "name": "Costa rica", "value": "costa rica", "tokens": ["costa rica"] },
      { "name": "Cote d'ivoire", "value": "cote d’ivoire", "tokens": ["cote d’ivoire, the ivory coast"] },
      { "name": "Croatia", "value": "croatia", "tokens": ["croatia", "hrvatska"] },
      { "name": "Cuba", "value": "cuba", "tokens": ["cuba"] },
      { "name": "Curaçao", "value": "curaçao", "tokens": ["curaçao, curacao"] },
      { "name": "Cyprus", "value": "cyprus", "tokens": ["cyprus"] },
      { "name": "Czech republic", "value": "czech republic", "tokens": ["czech republic"] },
      { "name": "Democratic republic of Congo", "value": "democratic republic of congo", "tokens": ["democratic republic of congo, zaire"] },
      { "name": "Denmark", "value": "denmark", "tokens": ["denmark"] },
      { "name": "Djibouti", "value": "djibouti", "tokens": ["djibouti"] },
      { "name": "Dominica", "value": "dominica", "tokens": ["dominica"] },
      { "name": "Dominican republic", "value": "dominican republic", "tokens": ["dominican republic"] },
      { "name": "Ecuador", "value": "ecuador", "tokens": ["ecuador"] },
      { "name": "Egypt", "value": "egypt", "tokens": ["egypt"] },
      { "name": "El salvador", "value": "el salvador", "tokens": ["el salvador"] },
      { "name": "Equatorial guinea", "value": "equatorial guinea", "tokens": ["equatorial guinea"] },
      { "name": "Eritrea", "value": "eritrea", "tokens": ["eritrea"] },
      { "name": "Estonia", "value": "estonia", "tokens": ["estonia"] },
      { "name": "Ethiopia", "value": "ethiopia", "tokens": ["ethiopia", "abyssinia"] },
      { "name": "Falkland islands", "value": "falkland islands", "tokens": ["falkland islands"] },
      { "name": "Fiji", "value": "fiji", "tokens": ["fiji"] },
      { "name": "Finland", "value": "finland", "tokens": ["finland"] },
      { "name": "France", "value": "france", "tokens": ["france"] },
      { "name": "French guiana", "value": "french guiana", "tokens": ["french guiana"] },
      { "name": "French polynesia", "value": "french polynesia", "tokens": ["french polynesia"] },
      { "name": "Gabon", "value": "gabon", "tokens": ["gabon"] },
      { "name": "Gambia", "value": "gambia", "tokens": ["gambia"] },
      { "name": "Georgia", "value": "georgia", "tokens": ["georgia"] },
      { "name": "Germany", "value": "germany", "tokens": ["germany"] },
      { "name": "Ghana", "value": "ghana", "tokens": ["ghana", "gold coast"] },
      { "name": "Gibraltar", "value": "gibraltar", "tokens": ["gibraltar"] },
      { "name": "Greece", "value": "greece", "tokens": ["greece", "hellas"] },
      { "name": "Grenada", "value": "grenada", "tokens": ["grenada"] },
      { "name": "Guadeloupe", "value": "guadeloupe", "tokens": ["guadeloupe"] },
      { "name": "Guatemala", "value": "guatemala", "tokens": ["guatemala"] },
      { "name": "Guernsey", "value": "guernsey", "tokens": ["guernsey"] },
      { "name": "Guinea", "value": "guinea", "tokens": ["guinea"] },
      { "name": "Guinea-bissau", "value": "guinea-bissau", "tokens": ["guinea-bissau"] },
      { "name": "Guyana", "value": "guyana", "tokens": ["guyana"] },
      { "name": "Haiti", "value": "haiti", "tokens": ["haiti"] },
      { "name": "Holy see", "value": "holy see", "tokens": ["holy see"] },
      { "name": "Honduras", "value": "honduras", "tokens": ["honduras"] },
      { "name": "Hong Kong", "value": "hong kong", "tokens": ["hong kong"] },
      { "name": "Hungary", "value": "hungary", "tokens": ["hungary"] },
      { "name": "Iceland", "value": "iceland", "tokens": ["iceland"] },
      { "name": "India", "value": "india", "tokens": ["india"] },
      { "name": "Indonesia", "value": "indonesia", "tokens": ["indonesia"] },
      { "name": "Iran", "value": "iran", "tokens": ["iran"] },
      { "name": "Iraq", "value": "iraq", "tokens": ["iraq", "mesopotamia"] },
      { "name": "Ireland", "value": "ireland", "tokens": ["ireland"] },
      { "name": "Isle of man", "value": "isle of man", "tokens": ["isle of man"] },
      { "name": "Isreal", "value": "israel", "tokens": ["israel"] },
      { "name": "Italy", "value": "italy", "tokens": ["italy"] },
      { "name": "Jamaica", "value": "jamaica", "tokens": ["jamaica"] },
      { "name": "Japan", "value": "japan", "tokens": ["japan"] },
      { "name": "Jersey", "value": "jersey", "tokens": ["jersey"] },
      { "name": "Jordan", "value": "jordan", "tokens": ["jordan"] },
      { "name": "Kazakhstan", "value": "kazakhstan", "tokens": ["kazakhstan"] },
      { "name": "Kenya", "value": "kenya", "tokens": ["kenya"] },
      { "name": "Kiribati", "value": "kiribati", "tokens": ["kiribati"] },
      { "name": "Kosovo", "value": "kosovo", "tokens": ["kosovo"] },
      { "name": "Kuwait", "value": "kuwait", "tokens": ["kuwait"] },
      { "name": "Kyrgyzstan", "value": "kyrgyzstan", "tokens": ["kyrgyzstan"] },
      { "name": "Laos", "value": "laos", "tokens": ["laos"] },
      { "name": "Latvia", "value": "latvia", "tokens": ["latvia"] },
      { "name": "Lebanon", "value": "lebanon", "tokens": ["lebanon"] },
      { "name": "Lesotho", "value": "lesotho", "tokens": ["lesotho", "basutoland"] },
      { "name": "Liberia", "value": "liberia", "tokens": ["liberia"] },
      { "name": "Libya", "value": "libya", "tokens": ["libya"] },
      { "name": "Liechtenstein", "value": "liechtenstein", "tokens": ["liechtenstein"] },
      { "name": "Lithuania", "value": "lithuania", "tokens": ["lithuania"] },
      { "name": "Luxembourg", "value": "luxembourg", "tokens": ["luxembourg"] },
      { "name": "Macao", "value": "macao", "tokens": ["macao"] },
      { "name": "Macedonia", "value": "macedonia", "tokens": ["macedonia"] },
      { "name": "Madagascar", "value": "madagascar", "tokens": ["madagascar"] },
      { "name": "Malawi", "value": "malawi", "tokens": ["malawi", "nyasaland"] },
      { "name": "Malaysia", "value": "malaysia", "tokens": ["malaysia", "sabah and sarawak"] },
      { "name": "Maldives", "value": "maldives", "tokens": ["maldives"] },
      { "name": "Mali", "value": "mali", "tokens": ["mali"] },
      { "name": "Malta", "value": "malta", "tokens": ["malta"] },
      { "name": "Marshall Islands", "value": "marshall islands", "tokens": ["marshall islands"] },
      { "name": "Martinique", "value": "martinique", "tokens": ["martinique"] },
      { "name": "Mauritania", "value": "mauritania", "tokens": ["mauritania"] },
      { "name": "Mauritius", "value": "mauritius", "tokens": ["mauritius"] },
      { "name": "Mayotte", "value": "mayotte", "tokens": ["mayotte"] },
      { "name": "Mexico", "value": "mexico", "tokens": ["mexico"] },
      { "name": "Micronesia", "value": "micronesia", "tokens": ["micronesia"] },
      { "name": "Moldova", "value": "moldova", "tokens": ["moldova"] },
      { "name": "Monaco", "value": "monaco", "tokens": ["monaco"] },
      { "name": "Mongolia", "value": "mongolia", "tokens": ["mongolia"] },
      { "name": "Montenegro", "value": "montenegro", "tokens": ["montenegro"] },
      { "name": "Montserrat", "value": "montserrat", "tokens": ["montserrat"] },
      { "name": "Morocco", "value": "morocco", "tokens": ["morocco"] },
      { "name": "Mozambique", "value": "mozambique", "tokens": ["mozambique"] },
      { "name": "Namibia", "value": "namibia", "tokens": ["namibia"] },
      { "name": "Nauru", "value": "nauru", "tokens": ["nauru"] },
      { "name": "Nepal", "value": "nepal", "tokens": ["nepal"] },
      { "name": "Netherlands", "value": "netherlands", "tokens": ["netherlands", "the netherlands, holland"] },
      { "name": "New caledonia", "value": "new caledonia", "tokens": ["new caledonia"] },
      { "name": "New Zealand", "value": "new zealand", "tokens": ["new zealand"] },
      { "name": "Nicaragua", "value": "nicaragua", "tokens": ["nicaragua"] },
      { "name": "Niger", "value": "niger", "tokens": ["niger"] },
      { "name": "Nigeria", "value": "nigeria", "tokens": ["nigeria"] },
      { "name": "North Korea", "value": "north korea", "tokens": ["north korea"] },
      { "name": "Norway", "value": "norway", "tokens": ["norway"] },
      { "name": "Oman", "value": "oman", "tokens": ["oman"] },
      { "name": "Pakistan", "value": "pakistan", "tokens": ["pakistan"] },
      { "name": "Palau", "value": "palau", "tokens": ["palau"] },
      { "name": "Panama", "value": "panama", "tokens": ["panama"] },
      { "name": "Papua New Guinea", "value": "papua new guinea", "tokens": ["papua new guinea"] },
      { "name": "Paraguay", "value": "paraguay", "tokens": ["paraguay"] },
      { "name": "Peru", "value": "peru", "tokens": ["peru"] },
      { "name": "Philippines", "value": "philippines", "tokens": ["philippines"] },
      { "name": "Pitcairn Island", "value": "pitcairn island", "tokens": ["pitcairn island"] },
      { "name": "Poland", "value": "poland", "tokens": ["poland"] },
      { "name": "Portugal", "value": "portugal", "tokens": ["portugal"] },
      { "name": "Qatar", "value": "qatar", "tokens": ["qatar"] },
      { "name": "Réunion", "value": "réunion", "tokens": ["réunion, reunion"] },
      { "name": "Romania", "value": "romania", "tokens": ["romania"] },
      { "name": "Russia", "value": "russia", "tokens": ["russia", "ussr"] },
      { "name": "Rwanda", "value": "rwanda", "tokens": ["rwanda"] },
      { "name": "Samoa", "value": "samoa", "tokens": ["samoa"] },
      { "name": "San marino", "value": "san marino", "tokens": ["san marino"] },
      { "name": "São tomé and principe", "value": "são tomé and principe", "tokens": ["são tomé and principe, sao tomé and principe"] },
      { "name": "Saudi Arabia", "value": "saudi arabia", "tokens": ["saudi arabia"] },
      { "name": "Senegal", "value": "senegal", "tokens": ["senegal"] },
      { "name": "Serbia", "value": "serbia", "tokens": ["serbia"] },
      { "name": "Seychelles", "value": "seychelles", "tokens": ["seychelles"] },
      { "name": "Sierra Leone", "value": "sierra leone", "tokens": ["sierra leone"] },
      { "name": "Singapore", "value": "singapore", "tokens": ["singapore"] },
      { "name": "Slovakia", "value": "slovakia", "tokens": ["slovakia"] },
      { "name": "Slovenia", "value": "slovenia", "tokens": ["slovenia"] },
      { "name": "Solomon Islands", "value": "solomon islands", "tokens": ["solomon islands"] },
      { "name": "Somalia", "value": "somalia", "tokens": ["somalia"] },
      { "name": "South Africa", "value": "south africa", "tokens": ["south africa"] },
      { "name": "South Georgia", "value": "south georgia and the south sandwich islands", "tokens": ["south georgia and the south sandwich islands"] },
      { "name": "South Korea", "value": "south korea", "tokens": ["south korea"] },
      { "name": "South Sudan", "value": "south sudan", "tokens": ["south sudan"] },
      { "name": "Spain", "value": "spain", "tokens": ["spain"] },
      { "name": "Sri Lanka", "value": "sri lanka", "tokens": ["sri lanka, ceylon"] },
      { "name": "St Helena", "value": "st helena, ascension and tristan da cunha", "tokens": ["st helena, ascension and tristan da cunha"] },
      { "name": "St Kitts and Nevis", "value": "st kitts and nevis", "tokens": ["st kitts and nevis"] },
      { "name": "St Lucia", "value": "st lucia", "tokens": ["st lucia"] },
      { "name": "St Maarten", "value": "st maarten", "tokens": ["st maarten"] },
      { "name": "St Pierre and Miquelon", "value": "st pierre & miquelon", "tokens": ["st pierre and miquelon, st pierre and miquelon"] },
      { "name": "St Vincent and the grenadines", "value": "st vincent and the grenadines", "tokens": ["st vincent and the grenadines"] },
      { "name": "Sudan", "value": "sudan", "tokens": ["sudan"] },
      { "name": "Suriname", "value": "suriname", "tokens": ["suriname", "dutch guiana"] },
      { "name": "Swaziland", "value": "swaziland", "tokens": ["swaziland"] },
      { "name": "Sweden", "value": "sweden", "tokens": ["sweden"] },
      { "name": "Switzerland", "value": "switzerland", "tokens": ["switzerland"] },
      { "name": "Syria", "value": "syria", "tokens": ["syria"] },
      { "name": "Taiwan", "value": "taiwan", "tokens": ["taiwan", "formosa"] },
      { "name": "Tajikistan", "value": "tajikistan", "tokens": ["tajikistan"] },
      { "name": "Tanzania", "value": "tanzania", "tokens": ["tanzania"] },
      { "name": "Thailand", "value": "thailand", "tokens": ["thailand"] },
      { "name": "The occupied Palestinian Territories", "value": "the occupied palestinian territories", "tokens": ["the occupied palestinian territories"] },
      { "name": "Timor Leste", "value": "timor leste", "tokens": ["timor leste"] },
      { "name": "Togo", "value": "togo", "tokens": ["togo"] },
      { "name": "Tonga", "value": "tonga", "tokens": ["tonga"] },
      { "name": "Trinidad and Tobago", "value": "trinidad and tobago", "tokens": ["trinidad and tobago"] },
      { "name": "Tunisia", "value": "tunisia", "tokens": ["tunisia"] },
      { "name": "Turkey", "value": "turkey", "tokens": ["turkey", "ottoman empire"] },
      { "name": "Turkmenistan", "value": "turkmenistan", "tokens": ["turkmenistan"] },
      { "name": "Turks and Caicos Islands", "value": "turks and caicos islands", "tokens": ["turks and caicos islands"] },
      { "name": "Tuvalu", "value": "tuvalu", "tokens": ["tuvalu"] },
      { "name": "Uganda", "value": "uganda", "tokens": ["uganda"] },
      { "name": "Ukrain", "value": "ukraine", "tokens": ["ukraine", "the ukraine"] },
      { "name": "United Arab Emirates", "value": "united arab emirates", "tokens": ["united arab emirates"] },
      { "name": "Uruguay", "value": "uruguay", "tokens": ["uruguay"] },
      { "name": "United States of America", "value": "united states of america", "tokens": ["united states of america, usa, u.s.a"] },
      { "name": "Uzbekistan", "value": "uzbekistan", "tokens": ["uzbekistan"] },
      { "name": "Vanuatu", "value": "vanuatu", "tokens": ["vanuatu"] },
      { "name": "Venezuela", "value": "venezuela", "tokens": ["venezuela"] },
      { "name": "Vietnam", "value": "vietnam", "tokens": ["vietnam"] },
      { "name": "Wallis and Futuna", "value": "wallis and futuna", "tokens": ["wallis and futuna"] },
      { "name": "Western Sahara", "value": "western sahara", "tokens": ["western sahara"] },
      { "name": "Yemen", "value": "yemen", "tokens": ["yemen"] },
      { "name": "Zambia", "value": "zambia", "tokens": ["zambia", "rhodesia"] },
      { "name": "Zimbabwe", "value": "zimbabwe", "tokens": ["zimbabwe", "rhodesia"] }
    ];


    // When you click something of importance
    $(document).on('click touchend', function(e) {
      // if you clicked add another country
      if ( e.target.id === 'add-another-country' ) {
        // Stop the link clicking
        e.preventDefault();
        // Run the add links function
        add_remove_links();
        // Run the sortg links function
        sort_remove_links();
      }

      // if you clicked a remove link
      if ( e.target.className === 'remove-link' ) {
        // Stop the link clicking
        e.preventDefault();
        // Remove the block containing the input field
        $(e.target).parents('.form-group').remove();
        // Run the sort links function
        sort_remove_links();
      }

      // if you clicked a country from the country list
      if ( e.target.className === 'country-link' ) {
        // find the input above the country list
        var input = $(e.target).parents('.form-group').find('.country-name');
        // change the text of the input to match the selected country
        input.val( $(e.target).text() );
      }

    });


    // When you unselect an input field
    $(document).on('blur', 'input', function() {
      if ( $(this).hasClass('country-name') ) {
        // Find the country list for this field
        var countryList = $(this).parent().find('.country-list');

        // if the country list is visible, and there is 3 or more
        // characters typed in the input field
        if ( countryList.css('display') != 'none' && $(this).val().length >= 3 ) {
          // Set the text in the input field to the first match
          $(this).val(countryList.children('span').text());
        }

        // Run the show hide country list function
        show_hide_country_list($(this), countryList);
      }
    });


    // When you click into an input field
    $(document).on('focus', 'input', function() {
      if ( $(this).hasClass('country-name') ) {
        // Find the country list for this input
        var countryList = $(this).parent().find('.country-list');

        // if there is nothing typed in this input
        if ( $(this).val().length === 0 ) {
          // Clear the country list
          countryList.html('');
        }

        // Run the show hide country list function
        show_hide_country_list($(this), countryList);
      }
    });


    // When you type in an input field
    $(document).on('keyup', '.country-name', function() {
      // Find the country list for this field
      var countryList = $(this).parent('.form-group').find('.country-list');

      // Run the country_match function
      var matched = country_match( $(this).val() );

      // Fill the country list with the matched countries
      countryList.html(matched);

      // Run the show hide country list function
      show_hide_country_list($(this), countryList);
    });


    // When you submit the form
    $('#countries').on('submit', function(e) {
      validate_form(e);
    });


    function validate_form(e) {
      // Set up array for valid fields and error messages
      var valid = [];
      var error_message = ['Check you have entered a valid country', ''];
      var invalid = 0;

      // Check each field for validation
      $('.country-name').each(function() {
        // Get the text from the field
        var input = $(this).val();

        // if the input is not empty
        if ( input.length > 0 ) {
          // Loop through each country in the list
          for ( var i = 0; i < countries.length; i++ ) {
            // If the text in the input matches a country
            // push it into the valid array
            if ( countries[i].name.toLowerCase() === input.toLowerCase() ) {
              valid.push($(this).attr('id'));
            }
          }
        }
        // If there is no text in the field and it is not the first field
        // on the page, then mark it as valid
        else if ( input.length === 0 && $(this).attr('id') !== 'country-name-1') {
          valid.push($(this).attr('id'));
        }
      });

      // If any of the fields are not valid, stop the submit and validate
      if ( valid.length !== $('.country-name').length ) {
        e.preventDefault();

        $('.country-name').each(function() {
          // if this country field is not in the valid array
          // add to the count of invalid fields and add error to this field
          if ( valid.indexOf( $(this).attr('id') ) < 0 ) {
            invalid++;
            $(this).parent().addClass('error');

            // if the first field has no text in the field, create an error
            // message to say that it is empty
            if ( $('.country-name:first').val().length === 0 ) {
              error_message[1] = 'You have not typed anything';
            }
            // else if there is invalid country names, create an error
            // to explain this
            else if ( invalid > 0 ) {
              error_message[1] = 'We could not find a country with this name';
            }

            $('#error-message').remove();
            $('#country-type-ahead').prepend('<div class="form-group error" id="error-message">' +
                                        '<span class="form-label-bold">' +
                                          error_message[0] +
                                        '</span>' +
                                        '<span class="error-message">' +
                                          error_message[1] +
                                        '</span>' +
                                      '</div>');
          }
          // else reduce the count of invalid fields and remove error from
          // this field
          else {
            invalid--;
            $(this).parent().removeClass('error');
          }
        });
      }


    }


    function country_match(i) {
      // Get the text in the input and convert to lowercase
      var input = i.toLowerCase();

      // Setup blank variables
      var matched = [];
      var html = '';

      // Loop each country in the list
      for ( var i = 0; i < countries.length; i++ ) {
        // if the text in the input matches the tokens of a country,
        // push that country into the matched array
        var tokens = countries[i].tokens.toString();

        if ( tokens.toLowerCase().indexOf(input) > -1 ) {
          matched.push(countries[i].name);

          // Quit loop if 4 countries have been matched
          if ( matched.length === 4 ) {
            break;
          }
        }
      }

      // Format each match in the array as html
      for ( var i = 0; i < matched.length; i++ ) {
        // Wrap each country in <span> tags and add it to the variable html
        html += '<span class="country-link">' + matched[i] + '</span>';
      }

      // Return the html variable
      return html;
    }


    function show_hide_country_list(element, countryList) {
      // Get the number of links in the country list
      var links = countryList.find('.country-link').length;

      // Find the first matched country
      var first_match = countryList.find('.country-link:first').text().toLowerCase();

      // if there is more than one character typed, more than one match,
      // the first match is not equal to what is typed and the input is active
      if (  element.val().length > 0 && element.is(':focus') &&
            links > 0 && first_match != $(element).val().toLowerCase() )
      {
        // Show the country list
        countryList.show();
      } else {
        // Hide the country list, the delay allows the click event to happen
        // on the country links, without it the list vanishes too early
        setTimeout(function() {
          countryList.hide();
        }, 100);
      }
    }


    function add_remove_links() {
      // Set the number for the next country field
      var element_num = $('.country-name').length + 1;

      // Add the html block for the new country
      $('#country-type-ahead').append(
        '<div class="form-group">' +
          '<label class="form-label" for="country-name-' + element_num + '">Country name <span class="remove-link"></span></label>' +
          '<input class="form-control country-name" id="country-name-' + element_num + '" type="text" name="country-name-' + element_num+ '" autocomplete="off">' +
          '<div class="country-list" style="display:none;">' +
            '' +
          '</div>' +
        '</div>'
      );
    }


    function sort_remove_links() {
      // if there is more than one country box on the page
      if ( $('.country-name').length > 1 ) {
        // Add the remove links to each block
        $('.form-label').each(function() {
          $(this).html('Country name <a href="#" class="remove-link">Remove</a>')
        });
      } else {
        // Remove the link from the block
        $('.form-label').each(function() {
          $(this).html('Country name')
        });
      }
    }
  });
</script>
